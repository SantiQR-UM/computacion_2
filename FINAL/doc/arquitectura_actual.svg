<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 1000" width="1200" height="1000">
  <defs>
    <style>
      .box { fill: white; stroke: #333; stroke-width: 2; }
      .title { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: #333; text-anchor: middle; }
      .text { font-family: Arial, sans-serif; font-size: 13px; fill: #333; }
      .small-text { font-family: Arial, sans-serif; font-size: 11px; fill: #666; }
      .arrow { stroke: #333; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .dashed { stroke-dasharray: 5,5; }
      .redis-diamond { fill: white; stroke: #e74c3c; stroke-width: 2; }
      .filesystem-box { fill: #fff8dc; stroke: #8b4513; stroke-width: 2; }
      .note-box { fill: #ffe6e6; stroke: #ff6666; stroke-width: 1; stroke-dasharray: 3,3; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="30" class="title" style="font-size: 22px; font-weight: bold;">Sistema Distribuido de Procesamiento de Video - Arquitectura Implementada</text>
  <text x="600" y="55" class="small-text" style="font-size: 12px;">Frames completos + Filesystem compartido + Celery + asyncio</text>

  <!-- Cliente -->
  <rect x="50" y="100" width="180" height="140" rx="15" class="box"/>
  <text x="140" y="130" class="title">Cliente CLI</text>
  <text x="140" y="155" class="text">argparse</text>
  <text x="140" y="175" class="small-text">--video input.mp4</text>
  <text x="140" y="190" class="small-text">--processing blur</text>
  <text x="140" y="205" class="small-text">--ipv6 / --ipv4</text>
  <text x="140" y="220" class="small-text">--out output.mp4</text>

  <!-- Servidor (asyncio) -->
  <rect x="350" y="80" width="320" height="200" rx="15" class="box"/>
  <text x="510" y="110" class="title">Servidor (asyncio)</text>
  <text x="510" y="140" class="text">1. Extrae frames con OpenCV</text>
  <text x="510" y="160" class="text">   (cv2.VideoCapture)</text>
  <text x="510" y="180" class="text">2. Encola frame COMPLETO</text>
  <text x="510" y="200" class="text">   a Celery (1 task por frame)</text>
  <text x="510" y="220" class="text">3. Polling: espera archivos</text>
  <text x="510" y="240" class="text">4. Re-ensambla video MP4</text>
  <text x="510" y="260" class="small-text">+ metrics collector</text>

  <!-- HTTP Preview (NO implementado) -->
  <rect x="750" y="100" width="200" height="120" rx="15" class="note-box"/>
  <text x="850" y="130" class="title" style="fill: #cc0000;">HTTP Preview</text>
  <text x="850" y="155" class="text" style="fill: #cc0000;">❌ NO IMPLEMENTADO</text>
  <text x="850" y="175" class="small-text" style="fill: #999;">:8080 (planeado)</text>
  <text x="850" y="190" class="small-text" style="fill: #999;">/metrics</text>
  <text x="850" y="205" class="small-text" style="fill: #999;">/frame/&lt;n&gt;</text>

  <!-- Conexiones Cliente-Servidor -->
  <path d="M 230 170 L 350 170" class="arrow"/>
  <text x="270" y="160" class="small-text">TCP dual-stack</text>
  <text x="270" y="185" class="small-text">IPv4/IPv6, :9090</text>

  <path d="M 350 200 L 230 200" class="arrow dashed"/>
  <text x="250" y="220" class="small-text">JSON + video</text>

  <!-- Redis (diamante) -->
  <g transform="translate(510, 390)">
    <path d="M 0,-50 L 80,0 L 0,50 L -80,0 Z" class="redis-diamond"/>
    <text x="0" y="-10" class="title" style="fill: #e74c3c;">Redis</text>
    <text x="0" y="10" class="small-text">(solo broker)</text>
    <text x="0" y="25" class="small-text" style="font-size: 10px;">result backend</text>
    <text x="0" y="40" class="small-text" style="font-size: 10px;">eliminado</text>
  </g>

  <!-- Filesystem Compartido -->
  <rect x="720" y="340" width="220" height="120" rx="10" class="filesystem-box"/>
  <text x="830" y="370" class="title" style="fill: #8b4513;">Volumen Compartido</text>
  <text x="830" y="395" class="text">/app/data/frames/</text>
  <text x="830" y="415" class="small-text">frame_000001.png</text>
  <text x="830" y="430" class="small-text">frame_000001.json</text>
  <text x="830" y="445" class="small-text">frame_000002.png</text>

  <!-- Conexiones Servidor-Redis -->
  <path d="M 510 280 L 510 340" class="arrow"/>
  <text x="430" y="310" class="small-text">encola tasks</text>
  <text x="430" y="325" class="small-text">(broker)</text>

  <!-- Conexión Servidor-Filesystem (polling) -->
  <path d="M 670 220 L 720 380" class="arrow dashed"/>
  <text x="680" y="300" class="small-text" style="fill: #8b4513;">polling</text>
  <text x="680" y="315" class="small-text" style="fill: #8b4513;">async</text>

  <!-- Workers Container -->
  <rect x="80" y="550" width="1040" height="400" rx="10" class="box" style="fill: #f8f9fa;"/>
  <text x="600" y="580" class="title" style="font-size: 18px;">Workers Pool (Celery) - 4 contenedores Docker</text>

  <!-- Worker 1 -->
  <g transform="translate(120, 610)">
    <rect x="0" y="0" width="230" height="300" rx="10" class="box"/>
    <text x="115" y="30" class="title">Worker 1</text>
    <text x="115" y="50" class="small-text">celery worker</text>

    <rect x="20" y="70" width="190" height="50" rx="5" class="box" style="fill: #e8f4f8;"/>
    <text x="115" y="95" class="text">process_frame()</text>
    <text x="115" y="112" class="small-text">Frame COMPLETO</text>

    <rect x="30" y="130" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="150" class="small-text">Filtros OpenCV</text>

    <rect x="30" y="165" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="185" class="small-text">blur / edges / faces</text>

    <rect x="30" y="200" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="220" class="small-text">→ frame procesado</text>

    <rect x="30" y="235" width="170" height="50" rx="3" class="box" style="fill: #fffacd;"/>
    <text x="115" y="255" class="small-text" style="fill: #8b4513;">Escribe a disco:</text>
    <text x="115" y="270" class="small-text" style="fill: #8b4513;">PNG + JSON stats</text>
  </g>

  <!-- Worker 2 -->
  <g transform="translate(390, 610)">
    <rect x="0" y="0" width="230" height="300" rx="10" class="box"/>
    <text x="115" y="30" class="title">Worker 2</text>
    <text x="115" y="50" class="small-text">celery worker</text>

    <rect x="20" y="70" width="190" height="50" rx="5" class="box" style="fill: #e8f4f8;"/>
    <text x="115" y="95" class="text">process_frame()</text>
    <text x="115" y="112" class="small-text">Frame COMPLETO</text>

    <rect x="30" y="130" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="150" class="small-text">Filtros OpenCV</text>

    <rect x="30" y="165" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="185" class="small-text">motion / custom</text>

    <rect x="30" y="200" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="220" class="small-text">→ frame procesado</text>

    <rect x="30" y="235" width="170" height="50" rx="3" class="box" style="fill: #fffacd;"/>
    <text x="115" y="255" class="small-text" style="fill: #8b4513;">Escribe a disco:</text>
    <text x="115" y="270" class="small-text" style="fill: #8b4513;">PNG + JSON stats</text>
  </g>

  <!-- Worker 3 -->
  <g transform="translate(660, 610)">
    <rect x="0" y="0" width="230" height="300" rx="10" class="box"/>
    <text x="115" y="30" class="title">Worker 3</text>
    <text x="115" y="50" class="small-text">celery worker</text>

    <rect x="20" y="70" width="190" height="50" rx="5" class="box" style="fill: #e8f4f8;"/>
    <text x="115" y="95" class="text">process_frame()</text>
    <text x="115" y="112" class="small-text">Frame COMPLETO</text>

    <rect x="30" y="130" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="150" class="small-text">Filtros OpenCV</text>

    <rect x="30" y="165" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="185" class="small-text">configurables</text>

    <rect x="30" y="200" width="170" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="115" y="220" class="small-text">→ frame procesado</text>

    <rect x="30" y="235" width="170" height="50" rx="3" class="box" style="fill: #fffacd;"/>
    <text x="115" y="255" class="small-text" style="fill: #8b4513;">Escribe a disco:</text>
    <text x="115" y="270" class="small-text" style="fill: #8b4513;">PNG + JSON stats</text>
  </g>

  <!-- Worker 4 -->
  <g transform="translate(930, 610)">
    <rect x="0" y="0" width="170" height="300" rx="10" class="box"/>
    <text x="85" y="30" class="title">Worker 4</text>
    <text x="85" y="50" class="small-text">celery worker</text>

    <rect x="10" y="70" width="150" height="50" rx="5" class="box" style="fill: #e8f4f8;"/>
    <text x="85" y="95" class="text" style="font-size: 12px;">process_frame()</text>
    <text x="85" y="112" class="small-text">Frame COMPLETO</text>

    <rect x="20" y="130" width="130" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="85" y="150" class="small-text">Filtros OpenCV</text>

    <rect x="20" y="165" width="130" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="85" y="185" class="small-text">+ detección</text>

    <rect x="20" y="200" width="130" height="30" rx="3" class="box" style="fill: white;"/>
    <text x="85" y="220" class="small-text">→ procesado</text>

    <rect x="20" y="235" width="130" height="50" rx="3" class="box" style="fill: #fffacd;"/>
    <text x="85" y="255" class="small-text" style="fill: #8b4513; font-size: 10px;">Escribe a disco:</text>
    <text x="85" y="270" class="small-text" style="fill: #8b4513; font-size: 10px;">PNG + JSON</text>
  </g>

  <!-- Conexiones Redis-Workers -->
  <path d="M 460 420 L 235 610" class="arrow"/>
  <path d="M 490 420 L 505 610" class="arrow"/>
  <path d="M 520 420 L 775 610" class="arrow"/>
  <path d="M 550 420 L 1015 610" class="arrow"/>

  <text x="330" y="510" class="small-text">distribuye tareas (broker)</text>

  <!-- Conexiones Workers-Filesystem -->
  <path d="M 350 840 L 720 420" class="arrow dashed" style="stroke: #8b4513;"/>
  <path d="M 620 840 L 780 460" class="arrow dashed" style="stroke: #8b4513;"/>
  <path d="M 890 840 L 840 460" class="arrow dashed" style="stroke: #8b4513;"/>
  <path d="M 1015 840 L 900 460" class="arrow dashed" style="stroke: #8b4513;"/>

  <text x="600" y="530" class="small-text" style="fill: #8b4513;">escriben frames procesados</text>
  <text x="600" y="545" class="small-text" style="fill: #8b4513;">+ JSON con estadísticas</text>

  <!-- Notas explicativas -->
  <rect x="50" y="970" width="1100" height="20" rx="5" class="box" style="fill: #f0f0f0;"/>
  <text x="60" y="985" class="small-text" style="font-weight: bold;">CAMBIO CLAVE: Redis solo como broker (no result backend). Workers escriben a filesystem compartido. Servidor hace polling asíncrono.</text>
</svg>
